include:
    - remote: 'https://gitlab.gnome.org/GNOME/citemplates/raw/master/flatpak/flatpak_ci_initiative.yml'
    - remote: "https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/0c312d9c7255f46e741d43bcd1930f09cd12efe7/templates/ci-fairy.yml"
    - remote: 'https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/0c312d9c7255f46e741d43bcd1930f09cd12efe7/templates/fedora.yml'

.vars-devel:
  variables:
    BUNDLE: "org.gnome.Shotwell.Devel.flatpak"
    GIT_SUBMODULE_STRATEGY: recursive
    MANIFEST_PATH: "flatpak/org.gnome.Shotwell.json"
    RUNTIME_REPO: "https://flathub.org/repo/flathub.flatpakrepo"
    FLATPAK_MODULE: "shotwell"
    APP_ID: "org.gnome.Shotwell"

flatpak@x86_64:
    extends: ['.flatpak@x86_64', '.vars-devel']

flatpak@aarch64:
    extends: ['.flatpak@aarch64', '.vars-devel']

nightly@x86_64:
    extends: '.publish_nightly'
    needs: ['flatpak@x86_64']

nightly@aarch64:
    extends: '.publish_nightly'
    needs: ['flatpak@aarch64']

pages:
  variables:
    BASE_TAG: '2023-04-09.0'
    FDO_UPSTREAM_REPO: GNOME/shotwell
    FDO_DISTRIBUTION_PACKAGES: 'yelp-tools ostree'
    FDO_DISTRIBUTION_VERSION : 37
    FDO_DISTRIBUTION_EXEC: |
      dnf clean all
    FDO_DISTRIBUTION_TAG: "x86_64-${BASE_TAG}"
  extends: .fdo.container-build@fedora

  stage: 'deploy'
  timeout: '100m'
  script:
    - tar xf repo.tar
    - ostree checkout --repo repo app/org.gnome.Shotwell/x86_64/master ostree-checkout -U
    - cp -rL ostree-checkout/files/share/help help-input
    - rm -rf ostree-checkout

    - for i in help-input/* ; do lang=$(basename $i) ; echo "Generating HTML doc for language $lang" ; mkdir -p doc/$lang/html ; ( cd doc/$lang/html ; yelp-build html ../../../help-input/$lang/shotwell ; cp -a ../../../help-input/$lang/shotwell/figures ) ; done 
    - mkdir public
    - mv doc public
  artifacts:
    paths:
       - 'public'
  needs:
    - 'flatpak@x86_64'
  only:
    refs:
      - 'master'
      - 'main'
      - 'mainline'
      - '/^wip\/(.*\/)?ci.*$/'
